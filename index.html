<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Downhill Games — Web Demo (n64js)</title>
  <meta name="description" content="Downhill Games: locked N64 web demo using n64js." />

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <!-- n64js styles -->
  <link rel="stylesheet" href="n64js.css">

  <style>
    :root{
      --bg:#0a0e0c; --panel:#0f1512; --stroke:rgba(255,255,255,.12);
      --fg:#e7fbe7; --muted:#a8b5a8; --accent:#19ff6a;
    }
    body{ background: radial-gradient(1200px 800px at 10% -10%, #0f1a14 0%, var(--bg) 60%), var(--bg); color:var(--fg);}
    h1#title{letter-spacing:.4px}
    .toolbar{ border-top:1px solid var(--stroke); border-bottom:1px solid var(--stroke); padding:.5rem 0; margin:.5rem 0 1rem}
    .btn{ border:1px solid var(--stroke) }
    #display{ background:#000; border-radius:12px; box-shadow:inset 0 0 0 1px rgba(255,255,255,.06)}
    #alerts{ min-height: 1rem }
    /* Hide things we’re not using */
    #fileInput{ display:none !important; visibility:hidden !important; }
    .btn-load, .btn-debug, .btn-perf { display:none !important; }
    /* Optional: hide the big debug/perf columns entirely */
    #performance, .debug, #adjacent-debug { display:none !important; }
    /* Simple brand pill */
    .brandpill{
      display:inline-flex; align-items:center; gap:.5rem; padding:.35rem .6rem; border-radius:999px;
      border:1px solid var(--stroke); color:var(--muted); font-size:.8rem
    }
    .brandpill i{ color:var(--accent) }
  </style>
</head>

<body>
  <div class="container-fluid">
    <div class="row align-items-center">
      <div class="col-sm-12 d-flex justify-content-between align-items-center">
        <div>
          <h1 id="title" class="m-0">Downhill Games — Web Demo</h1>
          <p class="m-0 text-secondary">N64 emulator in the browser (ROM-locked)</p>
        </div>
        <div class="brandpill"><i class="bi bi-cpu"></i> n64js</div>
      </div>
    </div>

    <div class="row toolbar">
      <div class="col-sm-12">
        <div class="btn-toolbar">
          <!-- Removed: Load (file picker), Debug, Perf -->
          <div class="btn-group">
            <button type="button" class="btn" onclick="n64js.ui().toggleControllerConfig()">
              <i class="bi bi-controller"></i> Controller</button>
            <button type="button" class="btn" onclick="n64js.toggleFullscreen()">
              <i class="bi bi-fullscreen"></i> Fullscreen</button>
          </div>
          <!-- Hidden original input, kept for API compatibility -->
          <input id="fileInput" name="fileInput" type="file" />
        </div>
      </div>
    </div>

    <div class="row"><div class="col-sm-12" id="alerts"></div></div>

    <div class="row">
      <div class="col-sm-12">
        <canvas id="display" width="640" height="480"></canvas>
      </div>
      <!-- performance/debug columns intentionally removed/hidden -->
    </div>

    <div class="row mt-3">
      <div class="col-sm-12 small text-secondary">
        Uses <a class="link-light" href="https://github.com/hulkholden/n64js" target="_blank" rel="noopener">n64js</a>. ROM loading UI disabled; autoloads site ROM.
      </div>
    </div>
  </div>

  <!-- (Keep this import map as in upstream) -->
  <script type="importmap">
    { "imports": { "lil-gui": "https://cdn.jsdelivr.net/npm/lil-gui@0.18.2/+esm" } }
  </script>

  <!-- Upstream deps -->
  <script src="js/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
  <script src="js/bootstrap-color-mode-toggler.js"></script>
  <script src="js/md5.js"></script>
  <script src="js/stats.js"></script>
  <script src="js/webgl-debug.js"></script>

  <!-- n64js core -->
  <script type="module" src="build/n64.min.js"></script>

  <!-- Shaders (unchanged) -->
  <script id="fill-shader-vs" type="x-shader/x-vertex">#version 300 es
    in vec4 aPosition;
    void main(void) { gl_Position = aPosition; }
  </script>
  <script id="fill-shader-fs" type="x-shader/x-fragment">#version 300 es
    precision mediump float; uniform vec4 uFillColor; out vec4 outCol;
    void main(void) { outCol = uFillColor; }
  </script>
  <script id="blit-shader-vs" type="x-shader/x-vertex">#version 300 es
    in vec4 aPosition; in vec2 aUV; out mediump vec2 vUV;
    void main(void){ gl_Position = aPosition; vUV = aUV; }
  </script>
  <script id="blit-shader-fs" type="x-shader/x-fragment">#version 300 es
    precision mediump float; in mediump vec2 vUV; out vec4 outCol;
    uniform sampler2D uSampler0;
    void main(void){ vec4 col = texture(uSampler0, vUV); outCol = vec4(col.rgb, 1); }
  </script>
  <script id="n64-shader-vs" type="x-shader/x-vertex">#version 300 es
    in vec4 aPosition; in vec4 aColor; in vec2 aUV;
    out vec4 vColor; out mediump vec2 vUV;
    void main(void){ gl_Position = aPosition; vColor = aColor; vUV = aUV; }
  </script>
  <script id="n64-shader-fs" type="x-shader/x-fragment">#version 300 es
    precision mediump float;
    in vec4 vColor; in mediump vec2 vUV; out vec4 outCol;
    uniform sampler2D uSampler0; uniform sampler2D uSampler1;
    uniform vec2 uTexOffset0; uniform vec2 uTexOffset1;
    uniform vec2 uTexScale0; uniform vec2 uTexScale1;
    uniform vec4 uPrimColor; uniform vec4 uEnvColor; uniform float uAlphaThreshold;
    void main(void){
      vec2 uv0=(vUV-uTexOffset0)*uTexScale0; vec2 uv1=(vUV-uTexOffset1)*uTexScale1;
      vec4 shade=vColor, prim=uPrimColor, env=uEnvColor;
      vec4 tex0=texture(uSampler0, uv0); vec4 tex1=texture(uSampler1, uv1);
      vec4 col = tex0; /* pipeline assembled in core */
      outCol = col;
    }
  </script>

  <!-- ROM autoload (ROM-locked) -->
  <script>
    // Change this path if your ROM lives elsewhere:
    const ROM_URL = "/roms/gutterdome64.z64";

    async function fetchROM(url){
      const resp = await fetch(url);
      if (!resp.ok) throw new Error("Failed to fetch ROM: " + resp.status);
      const buf = await resp.arrayBuffer();
      return new Uint8Array(buf);
    }

    async function autoloadROM(){
      try{
        const u8 = await fetchROM(ROM_URL);

        // Try common n64js entry points across revisions:
        // 1) direct global
        if (window.n64js?.loadROM) {
          await window.n64js.loadROM(u8);
        }
        // 2) via UI helper
        else if (window.n64js?.ui && window.n64js.ui()?.loadROM) {
          await window.n64js.ui().loadROM(u8);
        }
        // 3) some builds expose emulator instance
        else if (window.n64js?.emulator?.loadROM) {
          await window.n64js.emulator.loadROM(u8);
        }
        // 4) fallback: common internal helper name
        else if (window.n64js?.loadROMFromBuffer) {
          await window.n64js.loadROMFromBuffer(u8);
        }
        else {
          console.error("No known n64js load function found. Check build/n64.min.js API.");
        }

        // Attempt to start running if not auto-started
        if (window.n64js?.toggleRun) {
          // If emulator is idle, toggleRun() usually starts it
          window.n64js.toggleRun();
        }
      } catch (e){
        console.error(e);
        const alerts = document.getElementById("alerts");
        alerts.innerHTML = '<div class="alert alert-danger">ROM load failed: '
          + String(e.message||e) + '</div>';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      // ensure n64js has initialized (build/n64.min.js calls n64js.init())
      // give it a tick then autoload
      setTimeout(autoloadROM, 50);
    });
  </script>
</body>
</html>
