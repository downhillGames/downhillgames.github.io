<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Downhill Games — n64js (Test Mode)</title>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <!-- n64js styles -->
  <link rel="stylesheet" href="n64js.css">

  <style>
    /* Downhill look */
    body{background:radial-gradient(1200px 800px at 10% -10%, #0f1a14 0%, #0a0e0c 60%), #0a0e0c;color:#e7fbe7}
    #display{background:#000; border-radius:12px; box-shadow:inset 0 0 0 1px rgba(255,255,255,.06)}
    .toolbar{ border-top:1px solid rgba(255,255,255,.12); border-bottom:1px solid rgba(255,255,255,.12); padding:.5rem 0; margin:.5rem 0 1rem }
    .btn{ border:1px solid rgba(255,255,255,.12) }
    #title{letter-spacing:.4px}
  </style>
</head>

<body>
  <div class="container-fluid">
    <div class="row"><div class="col col-sm-12">
      <h1 id="title" class="m-0">Downhill Games — n64js (Test Mode)</h1>
      <p class="text-secondary m-0">Click <b>Load</b> and choose a <code>.z64/.n64/.v64</code> file.</p>
    </div></div>

    <div class="row toolbar">
      <div class="col col-sm-12">
        <div class="btn-toolbar">
          <div class="btn-group">
            <!-- Load visible for testing -->
            <button type="button" class="btn" onclick="n64js.ui().triggerLoad()">
              <i class="bi bi-file-earmark-binary"></i> Load</button>
          </div>
          <div class="btn-group">
            <button type="button" class="btn" onclick="n64js.toggleRun()" id="runbutton">
              <i class="bi bi-play"></i> Run</button>
          </div>
          <div class="btn-group">
            <button type="button" class="btn" onclick="n64js.ui().toggleControllerConfig()">
              <i class="bi bi-controller"></i> Controller</button>
            <button type="button" class="btn" onclick="n64js.toggleFullscreen()">
              <i class="bi bi-fullscreen"></i> Fullscreen</button>
          </div>
          <div class="btn-group">
            <!-- Keep debug/perf available during testing (handy to diagnose) -->
            <button type="button" class="btn" onclick="n64js.debugger().toggle()">
              <i class="bi bi-bug"></i> Debug</button>
            <button type="button" class="btn" onclick="n64js.togglePerformance()">
              <i class="bi bi-graph-up"></i> Perf</button>
          </div>

          <!-- File input used by triggerLoad() -->
          <input style="display:inline-block;" id="fileInput" name="fileInput" type="file"
                 onchange="n64js.ui().loadFile()" />
        </div>
      </div>
    </div>

    <div class="row"><div class="col col-sm-12" id="alerts"></div></div>

    <div class="row">
      <div style="white-space:nowrap;" class="col col-sm-8">
        <canvas id="display" width="640" height="480" style="display:inline-block;"></canvas>
        <div id="adjacent-debug" class="col col-sm-10 debug debug-adjacent hidden"></div>
      </div>
      <div class="col col-sm-2" id="performance"></div>
    </div>

    <!-- Keep the full debug scaffolding present for API expectations -->
    <div class="row">
      <div class="col col-sm-8" id="info" style="display:none"></div>
    </div>

    <div class="debug hidden">
      <div class="row"><div class="col col-sm-4">
        <form>
          <div class="input-group">
            <button type="button" class="btn" onclick="n64js.step()"><i class="bi bi-skip-end"></i> Step</button>
          </div>
          <div class="input-group">
            <label class="form-label" for="speed">Speed</label>
            <input class="form-range" type="range" min="0" max="8" value="0" id="cpu-speed" />
          </div>
        </form>
      </div></div>

      <div class="row"><div class="col col-sm-12">
        <div class="tabbable">
          <ul class="nav nav-underline">
            <li class="nav-item"><button class="nav-link active" id="output-tab" data-bs-toggle="tab" data-bs-target="#output-content" type="button" role="tab">Output</button></li>
            <li class="nav-item"><button class="nav-link" id="cpu-tab" data-bs-toggle="tab" data-bs-target="#cpu-content" type="button" role="tab">CPU</button></li>
            <li class="nav-item"><button class="nav-link" id="rsp-tab" data-bs-toggle="tab" data-bs-target="#rsp-content" type="button" role="tab">RSP</button></li>
            <li class="nav-item"><button class="nav-link" id="memory-tab" data-bs-toggle="tab" data-bs-target="#memory-content" type="button" role="tab">Memory</button></li>
            <li class="nav-item"><button class="nav-link" id="dynarec-tab" data-bs-toggle="tab" data-bs-target="#dynarec-content" type="button" role="tab">Dynarec</button></li>
            <li class="nav-item"><button class="nav-link" id="dlist-tab" data-bs-toggle="tab" data-bs-target="#dlist-content" type="button" role="tab">DisplayList</button></li>
            <li class="nav-item"><button class="nav-link" id="texture-tab" data-bs-toggle="tab" data-bs-target="#texture-content" type="button" role="tab">Textures</button></li>
            <li class="nav-item"><button class="nav-link" id="timeline-tab" data-bs-toggle="tab" data-bs-target="#timeline-content" type="button" role="tab">Timeline</button></li>
          </ul>
          <div class="tab-content">
            <div class="tab-pane active" id="output-content"></div>
            <div class="tab-pane" id="cpu-content"><div id="cpu" class="processor-display"></div></div>
            <div class="tab-pane" id="rsp-content"><div id="rsp" class="processor-display"></div></div>
            <div class="tab-pane" id="memory-content"><input type="text" placeholder="address" /><pre></pre></div>
            <div class="tab-pane" id="dlist-content"><div id="controls"></div></div>
            <div class="tab-pane" id="dynarec-content"></div>
            <div class="tab-pane" id="texture-content"></div>
            <div class="tab-pane" id="timeline-content"><div class="timeline-panel"></div></div>
          </div>
        </div>
      </div></div>
    </div>

    <div class="row">&nbsp;</div>

    <div class="row">
      <div class="col col-sm-12" id="output">
        <button type="button" class="btn" id="clear">
          <i class="bi bi-trash"></i> Clear</button>
        <div class="output fixed"></div>
      </div>
    </div>

    <div class="row mt-3"><div class="col col-sm-12 small text-secondary">
      Uses <a class="link-light" href="https://github.com/hulkholden/n64js" target="_blank" rel="noopener">n64js</a>. Test mode: manual ROM loading enabled.
    </div></div>
  </div>

  <!-- Controller modal kept as-is -->
  <div class="modal" tabindex="-1" id="controller">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Controls</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body"><table class="table table-sm"><tbody></tbody></table></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div></div>
  </div>

  <!-- Import map -->
  <script type="importmap">
    { "imports": { "lil-gui": "https://cdn.jsdelivr.net/npm/lil-gui@0.18.2/+esm" } }
  </script>

  <!-- Upstream deps -->
  <script src="js/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
          crossorigin="anonymous"></script>
  <script src="js/bootstrap-color-mode-toggler.js"></script>
  <script src="js/md5.js"></script>
  <script src="js/stats.js"></script>
  <script src="js/webgl-debug.js"></script>

  <!-- n64js core (initializes UI + hooks) -->
  <script type="module" src="build/n64.min.js"></script>

  <!-- Optional: auto-open picker with ?pick=1 -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(location.search);
      if (params.get('pick') === '1') {
        // Give n64js a tick to wire UI
        setTimeout(() => {
          try { n64js.ui().triggerLoad(); } catch (e) {}
        }, 100);
      }
    });
  </script>
</body>
</html>
