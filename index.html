<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gutterdome 64 — Web N64 Emulator</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root {
      --goo: #39ff14;
      --chrome: rgba(255,255,255,.08);
    }
    body{
      background: radial-gradient(1200px 600px at 20% -10%, #0e1712 0%, #0a0b0d 40%, #050607 100%);
      color:#e6efe6;
    }
    .card-chrome{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid var(--chrome);
      backdrop-filter: blur(4px);
    }
    .btn-goo{
      background: linear-gradient(180deg, rgba(57,255,20,.22), rgba(57,255,20,.12));
      color: var(--goo);
      border: 1px solid rgba(57,255,20,.35);
    }
    #display{
      border-radius:12px;border:1px solid rgba(57,255,20,.45);
      box-shadow:0 0 12px rgba(57,255,20,.18),0 0 36px rgba(57,255,20,.14), inset 0 0 18px rgba(57,255,20,.08);
      background:#000;
    }
    .sidebar { position: sticky; top: 1rem; }
    .toolbar .btn{ border:1px solid rgba(255,255,255,.1); }
    footer { opacity:.8 }
  </style>
</head>
<body>

  <header class="container-fluid pt-3">
    <div class="row align-items-center">
      <div class="col">
        <h1 class="h3 mb-0">Gutterdome 64</h1>
        <small class="text-secondary">Emulator powered by n64js</small>
      </div>
      <div class="col-auto">
        <div class="dropdown">
          <button class="btn btn-outline-light dropdown-toggle" id="bd-theme" type="button" data-bs-toggle="dropdown" data-bs-display="static">
            <span class="theme-icon-active"><i class="bi bi-brightness-high"></i></span>
            <span id="bd-theme-text">Theme</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li class="px-2 py-1"><button class="dropdown-item" type="button" data-bs-theme-value="light"><i class="bi bi-brightness-high me-2"></i>Light</button></li>
            <li class="px-2 py-1"><button class="dropdown-item" type="button" data-bs-theme-value="dark"><i class="bi bi-moon-stars me-2"></i>Dark</button></li>
            <li class="px-2 py-1"><button class="dropdown-item" type="button" data-bs-theme-value="auto"><i class="bi bi-circle-half me-2"></i>Auto</button></li>
          </ul>
        </div>
      </div>
    </div>
  </header>

  <!-- 3-column layout -->
  <div class="container-fluid mt-3">
    <div class="row g-4 align-items-start">

      <!-- LEFT: Dev Logs -->
      <aside class="col-12 col-lg-3">
        <div class="sidebar">
          <div class="card card-chrome mb-3">
            <div class="card-header">
              <i class="bi bi-journal-text me-1"></i> Dev Logs
            </div>
            <div class="list-group list-group-flush">
              <a class="list-group-item list-group-item-action" href="#">#12 Split-screen convergence fixes</a>
              <a class="list-group-item list-group-item-action" href="#">#11 Background render bug squash</a>
              <a class="list-group-item list-group-item-action" href="#">#10 Menu polish pass</a>
              <a class="list-group-item list-group-item-action" href="#">Archive…</a>
            </div>
          </div>
        </div>
      </aside>

      <!-- MIDDLE: Emulator -->
      <main class="col-12 col-lg-6">
        <!-- Toolbar -->
        <div class="row toolbar">
          <div class="col">
            <div class="btn-toolbar flex-wrap gap-2">
              <div class="btn-group">
                <a class="btn btn-goo" href="roms/gutterdome64.z64" download="gutterdome64.z64">
                  <i class="bi bi-download"></i> Download ROM
                </a>
              </div>

              <div class="btn-group">
                <button type="button" class="btn" onclick="n64js.ui().triggerLoad()">
                  <i class="bi bi-file-earmark-binary"></i> Load</button>
              </div>

              <div class="btn-group">
                <button type="button" class="btn" onclick="n64js.toggleRun()" id="runbutton">
                  <i class="bi bi-play"></i> Run</button>
              </div>

              <div class="btn-group">
                <button type="button" class="btn" onclick="n64js.ui().toggleControllerConfig()">
                  <i class="bi bi-controller"></i> Controller</button>
                <button type="button" class="btn" onclick="n64js.toggleFullscreen()">
                  <i class="bi bi-fullscreen"></i> Fullscreen</button>
              </div>

              <div class="btn-group">
                <button type="button" class="btn" onclick="n64js.debugger().toggle()">
                  <i class="bi bi-bug"></i> Debug</button>
                <button type="button" class="btn" onclick="n64js.togglePerformance()">
                  <i class="bi bi-graph-up"></i> Perf</button>
              </div>

              <input style="visibility:hidden; display:inline-block;" id="fileInput" name="fileInput" type="file"
                     onchange="n64js.ui().loadFile()" />
            </div>
          </div>
        </div>

        <div class="row mt-3">
          <div class="col" id="alerts"></div>
        </div>

        <!-- Display & Perf -->
        <div class="row g-3">
          <div class="col-12 col-lg-10">
            <canvas id="display" width="640" height="480"></canvas>
            <div id="adjacent-debug" class="debug debug-adjacent hidden"></div>
          </div>
          <div class="col-12 col-lg-2" id="performance"></div>
        </div>

        <!-- Info (collapsible block toggled by code UI) -->
        <div class="row mt-3">
          <div class="col" id="info" style="display:none">
            <h2>Status</h2>
            <p>Many games run at close to full speed… see GitHub for latest status.</p>
            <h2>Controls</h2>
            <table class="table table-sm">
              <thead><tr><th>N64</th><th>Keyboard</th></tr></thead>
              <tbody class="table-group-divider">
                <tr><td>Start</td><td>A</td></tr>
                <tr><td>A</td><td>S</td></tr>
                <tr><td>B</td><td>X</td></tr>
                <tr><td>Z</td><td>Z</td></tr>
                <tr><td>L</td><td>C</td></tr>
                <tr><td>R</td><td>V</td></tr>
                <tr><td>DPad Up</td><td>T</td></tr>
                <tr><td>DPad Down</td><td>G</td></tr>
                <tr><td>DPad Left</td><td>F</td></tr>
                <tr><td>DPad Right</td><td>H</td></tr>
                <tr><td>C Up</td><td>I</td></tr>
                <tr><td>C Down</td><td>K</td></tr>
                <tr><td>C Left</td><td>J</td></tr>
                <tr><td>C Right</td><td>L</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Output console -->
        <div class="row mt-3">
          <div class="col" id="output">
            <button type="button" class="btn btn-sm btn-outline-light" id="clear">
              <i class="bi bi-trash"></i> Clear</button>
            <div class="output fixed mt-2"></div>
          </div>
        </div>
      </main>

      <!-- RIGHT: Trailer -->
      <aside class="col-12 col-lg-3">
        <div class="card card-chrome mb-3">
          <div class="card-header"><i class="bi bi-film me-1"></i> Trailer</div>
          <div class="card-body">
            <div class="ratio ratio-16x9">
              <iframe
                src="https://www.youtube.com/embed/R7uo1EVlHDA"
                title="Gutterdome 64 Trailer"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen></iframe>
            </div>
          </div>
        </div>
      </aside>

    </div>
  </div>

  <!-- Controller modal (kept hooked to n64js UI) -->
  <div class="modal" tabindex="-1" id="controller">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Controls</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <table class="table table-sm">
            <thead><tr><th>N64</th><th>Keyboard</th></tr></thead>
            <tbody class="table-group-divider">
              <tr><td>Start</td><td><input type="text" id="controller-start" class="control-input" size="1" maxlength="1" value="A"></td></tr>
              <tr><td>A</td><td><input type="text" id="controller-a" class="control-input" size="1" maxlength="1" value="S"></td></tr>
              <tr><td>B</td><td><input type="text" id="controller-b" class="control-input" size="1" maxlength="1" value="X"></td></tr>
              <tr><td>Z</td><td><input type="text" id="controller-z" class="control-input" size="1" maxlength="1" value="Z"></td></tr>
              <tr><td>L</td><td><input type="text" id="controller-l" class="control-input" size="1" maxlength="1" value="C"></td></tr>
              <tr><td>R</td><td><input type="text" id="controller-r" class="control-input" size="1" maxlength="1" value="V"></td></tr>
              <tr><td>DPad Up</td><td><input type="text" id="controller-dup" class="control-input" size="1" maxlength="1" value="T"></td></tr>
              <tr><td>DPad Down</td><td><input type="text" id="controller-ddown" class="control-input" size="1" maxlength="1" value="G"></td></tr>
              <tr><td>DPad Left</td><td><input type="text" id="controller-dleft" class="control-input" size="1" maxlength="1" value="F"></td></tr>
              <tr><td>DPad Right</td><td><input type="text" id="controller-dright" class="control-input" size="1" maxlength="1" value="H"></td></tr>
              <tr><td>C Up</td><td><input type="text" id="controller-cup" class="control-input" size="1" maxlength="1" value="I"></td></tr>
              <tr><td>C Down</td><td><input type="text" id="controller-cdown" class="control-input" size="1" maxlength="1" value="K"></td></tr>
              <tr><td>C Left</td><td><input type="text" id="controller-cleft" class="control-input" size="1" maxlength="1" value="J"></td></tr>
              <tr><td>C Right</td><td><input type="text" id="controller-cright" class="control-input" size="1" maxlength="1" value="L"></td></tr>
            </tbody>
          </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary">Save changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Shader script tags kept for n64js renderer -->
  <script id="fill-shader-vs" type="x-shader/x-vertex">attribute vec4 aVertexPosition; void main(void){gl_Position=aVertexPosition;}</script>
  <script id="fill-shader-fs" type="x-shader/x-fragment">precision mediump float; uniform vec4 uFillColor; void main(void){gl_FragColor=uFillColor;}</script>
  <script id="blit-shader-vs" type="x-shader/x-vertex">attribute vec4 aVertexPosition; attribute vec2 aTextureCoord; varying mediump vec2 vTextureCoord; void main(void){gl_Position=aVertexPosition; vTextureCoord=aTextureCoord;}</script>
  <script id="blit-shader-fs" type="x-shader/x-fragment">precision mediump float; varying mediump vec2 vTextureCoord; uniform sampler2D uSampler0; void main(void){gl_FragColor=texture2D(uSampler0, vTextureCoord);}</script>
  <script id="n64-shader-vs" type="x-shader/x-vertex">attribute vec4 aVertexPosition; attribute vec4 aVertexColor; attribute vec2 aTextureCoord; varying vec4 vColor; varying mediump vec2 vTextureCoord; void main(void){gl_Position=aVertexPosition; vColor=aVertexColor; vTextureCoord=aTextureCoord;}</script>
  <script id="n64-shader-fs" type="x-shader/x-fragment">
    precision mediump float;
    varying vec4 vColor; varying mediump vec2 vTextureCoord;
    uniform sampler2D uSampler0; uniform sampler2D uSampler1;
    uniform vec2 uTexOffset0, uTexOffset1, uTexScale0, uTexScale1;
    uniform vec4 uPrimColor, uEnvColor; uniform float uAlphaThreshold;
    void main(void){
      vec2 t0=(vTextureCoord-uTexOffset0)*uTexScale0;
      vec2 t1=(vTextureCoord-uTexOffset1)*uTexScale1;
      vec4 col=texture2D(uSampler0,t0)*vColor; // simplified default
      gl_FragColor=col;
    }
  </script>

  <!-- JS deps -->
  <script src="js/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
          crossorigin="anonymous"></script>
  <script src="js/bootstrap-color-mode-toggler.js"></script>
  <script src="js/md5.js"></script>
  <script src="js/stats.js"></script>
  <script src="js/webgl-debug.js"></script>

  <!-- n64js core (module) -->
  <script type="module" src="build/n64.min.js"></script>

  <!-- Kick the emulator (retained) -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // n64js init (kept)
      n64js.init(); /* sets up canvas, key handlers, etc. */ 
      // (This matches the working behavior you had.) :contentReference[oaicite:4]{index=4}

      // --- ROM autoload chain (kept) ---
      const DRIVE_ID = '1R1zb9rPkbBL7_zzVCfiW2Cb0pUlRGr9c';
      function driveDirect(id){ return `https://drive.google.com/uc?export=download&id=${id}`; }
      function proxied(url){ return [ `https://corsproxy.io/?${encodeURIComponent(url)}`, `https://cors.isomorphic-git.org/${url}` ]; }

      function buildCandidates(){
        const qs = new URLSearchParams(location.search).get('rom');
        if (qs) return [qs];
        const direct = driveDirect(DRIVE_ID);
        return [direct, ...proxied(direct)];
      }
      async function fetchArrayBuffer(url){
        const res = await fetch(url,{cache:'no-store', redirect:'follow'});
        if(!res.ok || res.type==='opaque') throw new Error(`Fetch blocked or failed for ${url}`);
        return res.arrayBuffer();
      }
      function looksLikeText(buf){
        const head=new Uint8Array(buf,0,Math.min(buf.byteLength,64));
        let printable=0; for(let i=0;i<head.length;i++){const b=head[i]; if(b===9||b===10||b===13||(b>=32&&b<127)) printable++;}
        return printable>head.length*0.8;
      }
      async function tryLoad(url){
        const buf=await fetchArrayBuffer(url);
        if(looksLikeText(buf)) throw new Error('Got text/HTML instead of ROM bytes (Drive interstitial/CORS).');
        n64js.loadRomAndStartRunning(buf);
        console.log('[autoload] loaded', url);
      }
      (async function autoloadRom(){
        const urls = buildCandidates();
        let lastErr;
        for (const u of urls){
          try { await tryLoad(u); return; }
          catch(e){ lastErr=e; console.warn('[autoload] failed', u, e?.message||e); }
        }
        const msg='Failed to autoload ROM. Tried:\n'+urls.join('\n')+(lastErr?'\n\nLast error: '+(lastErr.message||String(lastErr)):'');
        (n64js.ui && n64js.ui().displayError)? n64js.ui().displayError(msg) : alert(msg);
      })();
    });
  </script>

  <!-- Optional first-gesture “unstick” nudge (kept; enable with ?unstick=1) -->
  <script>
    (function(){
      const ALWAYS_ON=false;
      const enabled = ALWAYS_ON || new URLSearchParams(location.search).get('unstick')==='1';
      if(!enabled) return;

      let armed=false, done=false;
      function nudge(delay=120){
        if(done) return; done=true;
        setTimeout(()=>{
          try{
            if(window.n64js && typeof n64js.toggleRun==='function'){
              n64js.toggleRun();
              setTimeout(()=>n64js.toggleRun(),100);
              console.log('[unstick] nudged core');
            }
          }catch(e){ console.warn('[unstick] toggleRun failed:', e); }
        }, delay);
      }
      function onDialogReturn(){
        window.removeEventListener('focus', onDialogReturn, true);
        document.removeEventListener('visibilitychange', onDialogReturn, true);
        nudge();
      }
      function firstGesture(){
        if(armed) return; armed=true;
        try{
          if(window.n64js && n64js.ui && typeof n64js.ui().triggerLoad==='function'){
            n64js.ui().triggerLoad();
            console.log('[unstick] called n64js.ui().triggerLoad()');
          } else { console.warn('[unstick] triggerLoad not available; aborting'); return; }
        }catch(e){ console.warn('[unstick] triggerLoad threw:', e); return; }
        window.addEventListener('focus', onDialogReturn, true);
        document.addEventListener('visibilitychange', ()=>{
          if(!done && document.visibilityState==='visible') onDialogReturn();
        }, { once:true });
        setTimeout(()=>{ if(!done) nudge(); }, 1500);
      }
      function arm(){
        const chip=document.createElement('button');
        chip.type='button';
        chip.textContent='Tap to start (unstick)';
        chip.style.cssText='position:fixed; inset:auto 1rem 1rem auto; z-index:99999; padding:.55rem .9rem; border-radius:999px; border:0; box-shadow:0 4px 14px rgba(0,0,0,.25); cursor:pointer; font:600 13px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;';
        chip.addEventListener('click', ()=>{ chip.remove(); firstGesture(); }, { once:true });
        document.body.appendChild(chip);
        const handler=()=>{ document.removeEventListener('click',handler,true); document.removeEventListener('keydown',handler,true); chip.remove(); firstGesture(); };
        document.addEventListener('click',handler,true);
        document.addEventListener('keydown',handler,true);
      }
      if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', arm, { once:true });
      else arm();
    })();
  </script>

  <footer class="mt-4 py-3 text-center small text-secondary">
    <div>© 2025 Downhill Games • Gutterdome 64 (prototype)</div>
    <div>Emulator powered by n64js (original authors & contributors). </div>
  </footer>

</body>
</html>
