<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <!-- (Optional) Google tag — keep or remove -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-VNCSM6YVD4"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date()); gtag('config', 'G-VNCSM6YVD4');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Downhill Games — Web Demo (n64js)</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="n64js.css">

  <style>
    /* Downhill look + hide stuff we don’t want visible */
    body{background:radial-gradient(1200px 800px at 10% -10%, #0f1a14 0%, #0a0e0c 60%), #0a0e0c;color:#e7fbe7}
    #display{background:#000; border-radius:12px; box-shadow:inset 0 0 0 1px rgba(255,255,255,.06)}
    /* keep elements in DOM but hide visually */
    .btn-load, .btn-debug, .btn-perf { visibility:hidden; display:none !important; }
    #performance, #adjacent-debug, .debug { display:none !important; }
    #fileInput { visibility:hidden; width:0; height:0; }
    .toolbar{ border-top:1px solid rgba(255,255,255,.12); border-bottom:1px solid rgba(255,255,255,.12); padding:.5rem 0; margin:.5rem 0 1rem }
    .btn{ border:1px solid rgba(255,255,255,.12) }
    #title{letter-spacing:.4px}
  </style>
</head>

<body>
  <div class="container-fluid">
    <div class="row"><div class="col col-sm-12">
      <h1 id="title">Downhill Games — Web Demo</h1>
      <p class="text-secondary">n64js running a locked ROM</p>
    </div></div>

    <div class="row toolbar">
      <div class="col col-sm-12">
        <div class="btn-toolbar">
          <div class="btn-group">
            <!-- Load button kept in DOM but hidden via CSS class -->
            <button type="button" class="btn btn-load" onclick="n64js.ui().triggerLoad()">
              <i class="bi bi-file-earmark-binary"></i> Load</button>
          </div>
          <div class="btn-group">
            <button type="button" class="btn" onclick="n64js.toggleRun()" id="runbutton">
              <i class="bi bi-play"></i> Run</button>
          </div>
          <div class="btn-group">
            <button type="button" class="btn" onclick="n64js.ui().toggleControllerConfig()">
              <i class="bi bi-controller"></i> Controller</button>
            <button type="button" class="btn" onclick="n64js.toggleFullscreen()">
              <i class="bi bi-fullscreen"></i> Fullscreen</button>
          </div>
          <div class="btn-group">
            <!-- Debug/Perf kept but hidden via CSS classes -->
            <button type="button" class="btn btn-debug" onclick="n64js.debugger().toggle()">
              <i class="bi bi-bug"></i> Debug</button>
            <button type="button" class="btn btn-perf" onclick="n64js.togglePerformance()">
              <i class="bi bi-graph-up"></i> Perf</button>
          </div>
          <div class="btn-group">
            <div class="dropdown">
              <button class="btn dropdown-toggle" id="bd-theme" type="button" data-bs-toggle="dropdown" data-bs-display="static">
                <span class="theme-icon-active"><i class="bi bi-moon-stars"></i></span>
                <span id="bd-theme-text">Theme</span>
              </button>
              <ul class="dropdown-menu">
                <li>
                  <button class="dropdown-item" type="button" data-bs-theme-value="light"><i class="bi bi-brightness-high"></i> Light</button>
                  <button class="dropdown-item" type="button" data-bs-theme-value="dark"><i class="bi bi-moon-stars"></i> Dark</button>
                  <button class="dropdown-item" type="button" data-bs-theme-value="auto"><i class="bi bi-circle-half"></i> Auto</button>
                </li>
              </ul>
            </div>
          </div>

          <input id="fileInput" name="fileInput" type="file" onchange="n64js.ui().loadFile()" />
        </div>
      </div>
    </div>

    <div class="row"><div class="col col-sm-12" id="alerts"></div></div>

    <div class="row">
      <div style="white-space:nowrap;" class="col col-sm-8">
        <canvas id="display" width="640" height="480" style="display:inline-block;"></canvas>
        <div id="adjacent-debug" class="col col-sm-10 debug debug-adjacent hidden"></div>
      </div>
      <div class="col col-sm-2" id="performance"></div>
    </div>

    <!-- Keep the full debug scaffolding present (hidden by CSS), so n64js never dereferences null -->
    <div class="row">
      <div class="col col-sm-8" id="info" style="display:none"></div>
    </div>

    <div class="debug hidden">
      <div class="row"><div class="col col-sm-4">
        <form>
          <div class="input-group">
            <button type="button" class="btn" onclick="n64js.step()"><i class="bi bi-skip-end"></i> Step</button>
          </div>
          <div class="input-group">
            <label class="form-label" for="speed">Speed</label>
            <input class="form-range" type="range" min="0" max="8" value="0" id="cpu-speed" />
          </div>
        </form>
      </div></div>

      <div class="row"><div class="col col-sm-12">
        <div class="tabbable">
          <ul class="nav nav-underline">
            <li class="nav-item"><button class="nav-link active" id="output-tab" data-bs-toggle="tab" data-bs-target="#output-content" type="button" role="tab">Output</button></li>
            <li class="nav-item"><button class="nav-link" id="cpu-tab" data-bs-toggle="tab" data-bs-target="#cpu-content" type="button" role="tab">CPU</button></li>
            <li class="nav-item"><button class="nav-link" id="rsp-tab" data-bs-toggle="tab" data-bs-target="#rsp-content" type="button" role="tab">RSP</button></li>
            <li class="nav-item"><button class="nav-link" id="memory-tab" data-bs-toggle="tab" data-bs-target="#memory-content" type="button" role="tab">Memory</button></li>
            <li class="nav-item"><button class="nav-link" id="dynarec-tab" data-bs-toggle="tab" data-bs-target="#dynarec-content" type="button" role="tab">Dynarec</button></li>
            <li class="nav-item"><button class="nav-link" id="dlist-tab" data-bs-toggle="tab" data-bs-target="#dlist-content" type="button" role="tab">DisplayList</button></li>
            <li class="nav-item"><button class="nav-link" id="texture-tab" data-bs-toggle="tab" data-bs-target="#texture-content" type="button" role="tab">Textures</button></li>
            <li class="nav-item"><button class="nav-link" id="timeline-tab" data-bs-toggle="tab" data-bs-target="#timeline-content" type="button" role="tab">Timeline</button></li>
          </ul>
          <div class="tab-content">
            <div class="tab-pane active" id="output-content"></div>
            <div class="tab-pane" id="cpu-content"><div id="cpu" class="processor-display"></div></div>
            <div class="tab-pane" id="rsp-content"><div id="rsp" class="processor-display"></div></div>
            <div class="tab-pane" id="memory-content"><input type="text" placeholder="address" /><pre></pre></div>
            <div class="tab-pane" id="dlist-content"><div id="controls"></div></div>
            <div class="tab-pane" id="dynarec-content"></div>
            <div class="tab-pane" id="texture-content"></div>
            <div class="tab-pane" id="timeline-content"><div class="timeline-panel"></div></div>
          </div>
        </div>
      </div></div>
    </div>

    <div class="row">&nbsp;</div>

    <div class="row">
      <div class="col col-sm-12" id="output">
        <button type="button" class="btn" id="clear">
          <i class="bi bi-trash"></i> Clear</button>
        <div class="output fixed"></div>
      </div>
    </div>

    <div class="row mt-3"><div class="col col-sm-12 small text-secondary">
      Uses <a class="link-light" href="https://github.com/hulkholden/n64js" target="_blank" rel="noopener">n64js</a>.
      UI elements for loading/diagnostics kept in DOM (hidden) to maintain compatibility; page auto-loads site ROM.
    </div></div>
  </div>

  <!-- Controller modal kept for compatibility -->
  <div class="modal" tabindex="-1" id="controller">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Controls</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body"><table class="table table-sm"><tbody></tbody></table></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div></div>
  </div>

  <!-- Import map -->
  <script type="importmap">
    { "imports": { "lil-gui": "https://cdn.jsdelivr.net/npm/lil-gui@0.18.2/+esm" } }
  </script>

  <!-- Upstream deps -->
  <script src="js/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
          crossorigin="anonymous"></script>
  <script src="js/bootstrap-color-mode-toggler.js"></script>
  <script src="js/md5.js"></script>
  <script src="js/stats.js"></script>
  <script src="js/webgl-debug.js"></script>

  <!-- n64js core -->
  <script type="module" src="build/n64.min.js"></script>

  <!-- Shaders (unchanged from upstream) -->
  <script id="fill-shader-vs" type="x-shader/x-vertex">#version 300 es
    in vec4 aPosition; void main(void){ gl_Position = aPosition; }
  </script>
  <script id="fill-shader-fs" type="x-shader/x-fragment">#version 300 es
    precision mediump float; uniform vec4 uFillColor; out vec4 outCol;
    void main(void){ outCol = uFillColor; }
  </script>
  <script id="blit-shader-vs" type="x-shader/x-vertex">#version 300 es
    in vec4 aPosition; in vec2 aUV; out mediump vec2 vUV;
    void main(void){ gl_Position = aPosition; vUV = aUV; }
  </script>
  <script id="blit-shader-fs" type="x-shader/x-fragment">#version 300 es
    precision mediump float; in mediump vec2 vUV; out vec4 outCol;
    uniform sampler2D uSampler0; void main(void){
      vec4 col = texture(uSampler0, vUV); outCol = vec4(col.rgb, 1);
    }
  </script>
  <script id="n64-shader-vs" type="x-shader/x-vertex">#version 300 es
    in vec4 aPosition; in vec4 aColor; in vec2 aUV;
    out vec4 vColor; out mediump vec2 vUV;
    void main(void){ gl_Position = aPosition; vColor = aColor; vUV = aUV; }
  </script>
  <script id="n64-shader-fs" type="x-shader/x-fragment">#version 300 es
    precision mediump float; in vec4 vColor; in mediump vec2 vUV; out vec4 outCol;
    uniform sampler2D uSampler0; uniform sampler2D uSampler1;
    uniform vec2 uTexOffset0, uTexOffset1, uTexScale0, uTexScale1;
    uniform vec4 uPrimColor, uEnvColor; uniform float uAlphaThreshold;
    void main(void){
      vec2 uv0=(vUV-uTexOffset0)*uTexScale0, uv1=(vUV-uTexOffset1)*uTexScale1;
      vec4 tex0=texture(uSampler0, uv0); outCol = vec4(tex0.rgb, 1.0);
    }
  </script>

  <!-- ROM autoload: keep DOM intact, just feed bytes to n64js -->
  <script>
    const ROM_URL = "/roms/gutterdome64.z64";

    async function fetchROM(url){
      const r = await fetch(url);
      if(!r.ok) throw new Error("Failed to fetch ROM: " + r.status);
      return new Uint8Array(await r.arrayBuffer());
    }

    function tryLoad(u8){
      // Try multiple entry points to be robust across builds
      if (window.n64js?.loadROM) return window.n64js.loadROM(u8);
      if (window.n64js?.ui && window.n64js.ui()?.loadROM) return window.n64js.ui().loadROM(u8);
      if (window.n64js?.emulator?.loadROM) return window.n64js.emulator.loadROM(u8);
      if (window.n64js?.loadROMFromBuffer) return window.n64js.loadROMFromBuffer(u8);
      throw new Error("No known n64js load function found");
    }

    async function boot(){
      try{
        // wait a tick for n64js.init() (called by build/n64.min.js) to finish wiring the UI
        await new Promise(r => setTimeout(r, 100));
        const u8 = await fetchROM(ROM_URL);
        await tryLoad(u8);
        // start running if it didn't auto-start
        window.n64js?.toggleRun && window.n64js.toggleRun();
      } catch(e){
        console.error(e);
        const alerts = document.getElementById("alerts");
        alerts.innerHTML = '<div class="alert alert-danger">ROM load failed: ' + String(e.message||e) + '</div>';
      }
    }

    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
